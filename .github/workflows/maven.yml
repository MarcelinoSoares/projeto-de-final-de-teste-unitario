# ğŸš€ Pipeline CI/CD Completo para Projeto de Testes UnitÃ¡rios
# Este workflow executa build, testes, anÃ¡lise de cÃ³digo, seguranÃ§a e gera relatÃ³rios

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]
  schedule:
    # Executa diariamente Ã s 2h da manhÃ£ para detectar problemas de dependÃªncias
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      debug_enabled:
        description: 'Executar com debug habilitado'
        required: false
        default: 'false'

env:
  JAVA_VERSION: '11'
  MAVEN_OPTS: '-Xmx3072m -XX:MaxMetaspaceSize=512m -XX:+UseG1GC'
  MAVEN_ARGS: '--batch-mode --errors --fail-at-end --show-version'

jobs:
  # Job 1: ValidaÃ§Ã£o inicial e setup
  validate:
    name: ğŸ” ValidaÃ§Ã£o e Setup
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
      version: ${{ steps.version.outputs.version }}

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # NecessÃ¡rio para anÃ¡lise completa

      - name: ğŸ”„ Verificar duplicaÃ§Ã£o
        id: skip_check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          concurrent_skipping: 'same_content_newer'
          skip_after_successful_duplicate: 'true'

      - name: ğŸ“Š Extrair versÃ£o do projeto
        id: version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ VersÃ£o do projeto: $VERSION"

  # Job 2: Build e Testes em mÃºltiplas versÃµes Java
  build-and-test:
    name: ğŸ—ï¸ Build e Testes (Java ${{ matrix.java }})
    needs: validate
    if: needs.validate.outputs.should_skip != 'true'
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        java: [11, 17, 21]
        exclude:
          # Excluir algumas combinaÃ§Ãµes para economizar recursos
          - os: windows-latest
            java: 17
          - os: macos-latest
            java: 17

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK ${{ matrix.java }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ matrix.java }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ“¦ Cache de dependÃªncias Maven
        uses: actions/cache@v4
        with:
          path: |
            ~/.m2/repository
            ~/.sonar/cache
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ğŸ”§ Validar projeto Maven
        run: mvn ${{ env.MAVEN_ARGS }} validate

      - name: ğŸ—ï¸ Compilar projeto
        run: mvn ${{ env.MAVEN_ARGS }} clean compile

      - name: ğŸ§ª Executar testes unitÃ¡rios
        run: mvn ${{ env.MAVEN_ARGS }} test
        env:
          MAVEN_OPTS: ${{ env.MAVEN_OPTS }} -Dnet.bytebuddy.experimental=true

      - name: ğŸ“Š Gerar relatÃ³rio de cobertura
        if: matrix.java == env.JAVA_VERSION && matrix.os == 'ubuntu-latest'
        run: mvn ${{ env.MAVEN_ARGS }} jacoco:report

      - name: ğŸ“¤ Upload relatÃ³rio de testes
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}-java${{ matrix.java }}
          path: |
            target/surefire-reports/
            target/site/jacoco/
          retention-days: 7

      - name: ğŸ“ˆ Publicar resultados dos testes
        if: always() && matrix.os == 'ubuntu-latest'
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            target/surefire-reports/*.xml
          check_name: Resultados dos Testes (Java ${{ matrix.java }})
          comment_mode: off

  # Job 3: AnÃ¡lise de CÃ³digo e Qualidade
  code-quality:
    name: ğŸ” AnÃ¡lise de Qualidade
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: â˜• Configurar JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ“¦ Restaurar cache Maven
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}

      - name: ğŸ” AnÃ¡lise SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn ${{ env.MAVEN_ARGS }} verify sonar:sonar \
            -Dsonar.projectKey=cesar-school_eta-unit-testing-project-2019.2-Recife \
            -Dsonar.organization=cesar-school \
            -Dsonar.host.url=https://sonarcloud.io \
            -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml

      - name: ğŸ“Š Upload para Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./target/site/jacoco/jacoco.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: ğŸ¯ Verificar cobertura mÃ­nima
        run: |
          mvn ${{ env.MAVEN_ARGS }} jacoco:check \
            -Djacoco.check.line.coverage=0.80 \
            -Djacoco.check.branch.coverage=0.75

  # Job 4: AnÃ¡lise de SeguranÃ§a
  security:
    name: ğŸ”’ AnÃ¡lise de SeguranÃ§a
    needs: validate
    if: needs.validate.outputs.should_skip != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ” OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'unit-testing-project'
          path: '.'
          format: 'HTML'
          args: >
            --enableRetired
            --enableExperimental

      - name: ğŸ“¤ Upload relatÃ³rio OWASP
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: owasp-dependency-check-report
          path: reports/
          retention-days: 7

      - name: ğŸ” AnÃ¡lise CodeQL
        uses: github/codeql-action/analyze@v3
        with:
          languages: java

  # Job 5: Testes de MutaÃ§Ã£o
  mutation-testing:
    name: ğŸ§¬ Testes de MutaÃ§Ã£o
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ§¬ Executar testes de mutaÃ§Ã£o
        run: |
          mvn ${{ env.MAVEN_ARGS }} test-compile org.pitest:pitest-maven:mutationCoverage \
            -DtimestampedReports=false \
            -DmutationThreshold=80
        continue-on-error: true

      - name: ğŸ“¤ Upload relatÃ³rio de mutaÃ§Ã£o
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pitest-report
          path: target/pit-reports/
          retention-days: 7

  # Job 6: Build da DocumentaÃ§Ã£o
  documentation:
    name: ğŸ“š Gerar DocumentaÃ§Ã£o
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ“– Gerar Javadoc
        run: mvn ${{ env.MAVEN_ARGS }} javadoc:javadoc

      - name: ğŸ“Š Gerar relatÃ³rio do site
        run: mvn ${{ env.MAVEN_ARGS }} site

      - name: ğŸ“¤ Upload documentaÃ§Ã£o
        uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: target/site/
          retention-days: 30

  # Job 7: Release (apenas em push para main)
  release:
    name: ğŸš€ Release
    needs: [build-and-test, code-quality, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Configurar JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: 'maven'

      - name: ğŸ“¦ Criar pacote
        run: mvn ${{ env.MAVEN_ARGS }} package -DskipTests

      - name: ğŸ·ï¸ Criar tag de release
        if: contains(needs.validate.outputs.version, 'SNAPSHOT') == false
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag -a v${{ needs.validate.outputs.version }} -m "Release version ${{ needs.validate.outputs.version }}"
          git push origin v${{ needs.validate.outputs.version }}

      - name: ğŸ“¤ Upload artefatos de release
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: target/*.jar
          retention-days: 90

  # Job 8: NotificaÃ§Ã£o de Status
  notify:
    name: ğŸ“¢ NotificaÃ§Ã£o
    needs: [build-and-test, code-quality, security, documentation]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“Š Resumo do Pipeline
        run: |
          echo "## ğŸ“Š Resumo do Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build e Testes | ${{ needs.build-and-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Qualidade de CÃ³digo | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| SeguranÃ§a | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DocumentaÃ§Ã£o | ${{ needs.documentation.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tempo total:** ${{ github.run_number }} minutos" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¬ Comentar no PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Resultados do CI/CD')
            );

            const body = `## ğŸ¤– Resultados do CI/CD

            | VerificaÃ§Ã£o | Status |
            |-------------|--------|
            | ğŸ—ï¸ Build | ${{ needs.build-and-test.result == 'success' && 'âœ… Sucesso' || 'âŒ Falhou' }} |
            | ğŸ§ª Testes | ${{ needs.build-and-test.result == 'success' && 'âœ… Passando' || 'âŒ Falhando' }} |
            | ğŸ“Š Qualidade | ${{ needs.code-quality.result == 'success' && 'âœ… Aprovado' || 'âš ï¸ Problemas' }} |
            | ğŸ”’ SeguranÃ§a | ${{ needs.security.result == 'success' && 'âœ… Seguro' || 'âš ï¸ Verificar' }} |
            | ğŸ“š Docs | ${{ needs.documentation.result == 'success' && 'âœ… Gerado' || 'âš ï¸ Erro' }} |

            **Commit:** \`${context.sha.substring(0, 7)}\`
            **Executado em:** ${new Date().toLocaleString('pt-BR')}

            [Ver detalhes completos â†’](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
